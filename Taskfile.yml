version: '3'

vars:
  ENV: prod

tasks:
  init-backend:
    desc: "Create/prepare remote state backend (RG, Storage, Container)"
    cmds:
      - ./infra/scripts/bootstrap-backend.sh {{.RG}} {{.SA}} {{.CN}} {{.LOCATION}}

  tf-init:
    dir: infra/envs/{{.ENV}}
    cmds:
      - terraform init {{.ARGS}}

  tf-plan:
    dir: infra/envs/{{.ENV}}
    cmds:
      - terraform plan {{.ARGS}}

  tf-apply:
    dir: infra/envs/{{.ENV}}
    cmds:
      - terraform apply -auto-approve {{.ARGS}}

  kubeconfig:
    desc: "Print basic cluster info via az aks command invoke"
    cmds:
      - ./infra/scripts/print-aks-kubeconfig.sh

  destroy:
    dir: infra/envs/{{.ENV}}
    cmds:
      - terraform destroy -auto-approve {{.ARGS}}

  validate:
    desc: "Validate all Terraform configurations"
    cmds:
      - terraform validate
    dir: infra/envs/{{.ENV}}

  fmt:
    desc: "Format Terraform files"
    cmds:
      - terraform fmt -recursive
    dir: infra

